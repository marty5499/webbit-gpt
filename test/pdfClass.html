<!DOCTYPE html>
<html>

<head>
    <title>PDF Viewer</title>
    <!-- Include pdf.js CSS files -->
    <link rel="stylesheet" type="text/css" href="https://mozilla.github.io/pdf.js/web/viewer.css">
    <style>
        #pdfContainer {
            height: 100vh;
            overflow-y: scroll;
        }

        .highlight {
            color: brown;
            background-color: rgb(33, 20, 205);
        }
    </style>
</head>

<body> <button id="zoomIn">放大</button>
    <button id="zoomOut">縮小</button>
    <button id="fitWidth">滿版</button>
    <div id="pdfContainer">
    </div>
    <!-- Include pdf.js JavaScript files -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script>
        var selectedText = ""; // To store selected text
        var highlightTimeout;

        class PDF {
            constructor(pdfUrl) {
                this.pdfUrl = pdfUrl;
                this.pdfContainer = document.getElementById("pdfContainer");
                this.scale = 1;  // Initialize scale
                // Initialize PDF.js settings
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.js';

                // Listen for the scroll event
                this.pdfContainer.addEventListener('scroll', () => {
                    // Get all page elements
                    const pageElements = Array.from(this.pdfContainer.children);
                    // Find the first page element that is (partially) visible in the viewport
                    const visiblePageElement = pageElements.find(pageElement => {
                        const rect = pageElement.getBoundingClientRect();
                        return rect.top >= 0 && rect.top < window.innerHeight;
                    });

                    // Update this.nowPageNum
                    if (visiblePageElement) {
                        this.nowPageNum = parseInt(visiblePageElement.id.split('-')[1]);
                        console.log("Page:", this.nowPageNum);
                    }
                });

            }

            async zoomIn() {
                this.scale += 0.2;
                await this.load();  // Re-load the PDF after changing the scale
            }

            async zoomOut() {
                this.scale -= 0.2;
                await this.load();  // Re-load the PDF after changing the scale
            }

            async fitWidth() {
                // Get the first page
                const page = await this.pdfDoc.getPage(1);
                // Get the viewport for the page at scale 1
                const unscaledViewport = page.getViewport({ scale: 1 });
                // Calculate the scale necessary to fit the page width to the container width
                this.scale = this.pdfContainer.clientWidth / unscaledViewport.width;
                // Re-load the PDF
                await this.load();
            }

            async load() {
                try {
                    this.pdfContainer.innerHTML = '';
                    // Start loading the PDF
                    const pdfDoc = await pdfjsLib.getDocument(this.pdfUrl).promise;
                    this.pdfDoc = pdfDoc; // Save the pdfDoc
                    for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                        await this.renderPage(pageNum);
                    }
                } catch (error) {
                    // Handle any errors that occur during loading
                    console.error('Error loading PDF:', error);
                }
            }

            async find(keyword) {
                // Loop through each page in the PDF
                for (let pageNum = 1; pageNum <= this.pdfDoc.numPages; pageNum++) {
                    const page = await this.pdfDoc.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    console.log("pageNum:", pageNum, textContent);
                    // Convert the text items to a single string
                    const textItems = textContent.items.map(item => item.str);
                    const pageText = textItems.join(' ');
                    // Search for the keyword in the page text
                    if (pageText.includes(keyword)) {
                        console.log(">>>>", pageNum, ",find:", keyword);

                        // Scroll to the page
                        this.page(pageNum);

                        // Highlight the keyword on the page
                        var pageDiv = document.getElementById("page-" + pageNum);
                        if (pageDiv) {
                            var textLayerDiv = pageDiv.querySelector(".textLayer");
                            if (textLayerDiv) {
                                var textElements = Array.from(textLayerDiv.getElementsByTagName('span'));
                                textElements.forEach(function (element) {
                                    if (element.textContent.includes(keyword)) {
                                        element.classList.add('highlight');
                                    }
                                });
                            }
                        }
                        break;
                    }
                }
            }

            nowPage() {
                return this.nowPageNum;
            }

            page(pageNum) {
                this.nowPageNum = pageNum;
                // Scroll to the specified page
                var pageDiv = document.getElementById("page-" + pageNum);
                if (pageDiv) {
                    pageDiv.scrollIntoView();
                }
            }

            async renderPage(pageNum, keyword = null) {
                console.log("load :", this.scale);
                const page = await this.pdfDoc.getPage(pageNum);
                var viewport = page.getViewport({ scale: this.scale });  // Use the current scale
                var canvas = document.createElement("canvas");
                var context = canvas.getContext('2d');
                var textLayerDiv = document.createElement("div");
                var pageDiv = document.createElement("div");

                // Set an ID for the pageDiv
                pageDiv.id = "page-" + pageNum;

                // Set up pageDiv
                pageDiv.style.position = 'relative';
                pageDiv.style.width = viewport.width + "px";
                pageDiv.style.height = viewport.height + "px";
                pageDiv.style.marginBottom = '20px';

                // Set up text layer
                textLayerDiv.className = "textLayer";
                textLayerDiv.style.width = "100%";
                textLayerDiv.style.height = "100%";
                textLayerDiv.style.position = 'absolute';
                textLayerDiv.style.top = "0";
                textLayerDiv.style.left = "0";
                textLayerDiv.style.setProperty("--scale-factor", this.scale);

                // Set up the canvas
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.width = "100%";
                canvas.style.height = "100%";
                canvas.style.position = 'absolute';
                canvas.style.top = "0";
                canvas.style.left = "0";

                // Append elements to the pageDiv
                pageDiv.appendChild(canvas);
                pageDiv.appendChild(textLayerDiv);

                // Retrieve the text content and render it onto the textLayer
                const textContent = await page.getTextContent();

                // Render the page onto the canvas
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                // Render the text layer
                pdfjsLib.renderTextLayer({
                    textContentSource: textContent,
                    container: textLayerDiv,
                    viewport: viewport,
                    textDivs: [],
                    enhanceTextSelection: true,
                    textContentStream: true
                });
                // Append the rendered page to the container
                this.pdfContainer.appendChild(pageDiv);

                // Add event listener for text selection
                textLayerDiv.addEventListener("mouseup", function (event) {
                    var selectedRange = window.getSelection().getRangeAt(0);
                    selectedText = selectedRange.toString().trim();
                    setTimeout(function () {
                        console.log(selectedText);
                    }, 1000);
                });

                textLayerDiv.addEventListener("mouseover", function (event) {
                    if (highlightTimeout) clearTimeout(highlightTimeout);

                    highlightTimeout = setTimeout(function () {
                        var target = event.target;

                        // Skip if the target is not a span (i.e., not a text element)
                        if (target.tagName.toLowerCase() !== 'span') return;

                        // Remove all existing highlights
                        var highlightedElements = document.querySelectorAll('.highlight');
                        highlightedElements.forEach(function (element) {
                            element.classList.remove('highlight');
                        });

                        // Get the position of the target element
                        var targetRect = target.getBoundingClientRect();

                        // Get all text elements
                        var textElements = Array.from(textLayerDiv.getElementsByTagName('span'));

                        // Function to check if an element is in the same block as the target
                        var isInSameBlock = function (element) {
                            var rect = element.getBoundingClientRect();

                            // Check if the element is in the same line as the target
                            // This is a simple check and might not work correctly for all PDFs
                            return Math.abs(rect.top - targetRect.top) < rect.height * 3;
                        };

                        // Get all elements in the same block
                        var sameBlockElements = textElements.filter(isInSameBlock);

                        if (sameBlockElements.length) {
                            console.log('Text block:', sameBlockElements.map(function (element) {
                                return element.textContent;
                            }).join(' '));

                            // Highlight all elements in the same block
                            sameBlockElements.forEach(function (element) {
                                element.classList.add('highlight');
                            });
                        }
                    }, 1000);
                });

            }
        }
        var pdf = new PDF('./book.pdf');

        ((async function () {
            await pdf.load();
            //pdf.find("正片後像");
            //pdf.page(1);
            document.getElementById('zoomIn').addEventListener('click', async function () {
                pdf.zoomIn();
            });

            document.getElementById('zoomOut').addEventListener('click', async function () {
                pdf.zoomOut();
            });

            document.getElementById('fitWidth').addEventListener('click', async function () {
                pdf.fitWidth();
            });

        })())
    </script>
</body>

</html>