<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Create AI</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script src="./mqttapp.js"></script>
</head>

<body>
    <div class="box-form">
        <div class="left">
            <div class="overlay">
                <h2>我的小書僮</h2>
                <p>建立屬於您的小書僮，幫您讀書，解答您的問題...</p>
            </div>
        </div>
        <div class="right">
            <h1>建立</h1>
            <p>powered by Webduino</p>
            <div class="inputs">
                <input id='aiName' type="text" placeholder="小書僮名字" value="">
                <br>
                <input id='aiMemo' type="text" placeholder="小書僮描述" value="">
                <br>
                <input id='aiImg' type="text" placeholder="小書僮圖片 320x240 連結 " value="">
                <br>
                <input id='aiFolderURL' type="text" placeholder="Google 雲端硬碟目錄連結" value="">
            </div>
            <br><br>
            <div id="msg" style="height:80px;width:200px;font-size:1.5em"></div>
            <br>
            <button id="btn" class='create-button' onclick="create()">建立</button>
        </div>
    </div>

    <script>

        //*/ test
        aiName.value = "Marty";
        aiMemo.value = "我的小書僮";
        aiImg.value = 'https://md.webduino.io/uploads/upload_9de4c14d7a91ee5d8282ceaf0116f6f0.png';
        aiFolderURL.value = 'https://drive.google.com/drive/u/0/folders/15TYIANBu5Y0h8kj18ASY9sGMBm7xk0oE'
        //*/

        function disableBtn() {
            btn.disabled = true;
            btn.classList.remove('create-button');
            btn.classList.add('create-button-disable');

        }

        function create() {
            disableBtn();
            var msg = document.getElementById('msg');
            var aiName = document.getElementById('aiName').value.trim();
            var aiMemo = document.getElementById('aiMemo').value.trim();
            var aiImg = document.getElementById('aiImg').value.trim();
            var aiFolderURL = document.getElementById('aiFolderURL').value.trim();

            var url = 'https://chat.nodered.vip/api/create?' +
                'srcFolderURL=' + aiFolderURL +
                '&aiName=' + aiName +
                '&aiMemo=' + aiMemo +
                '&aiImg=' + aiImg +
                "&aiFolderURL=" + aiFolderURL;

            msg.innerHTML = "建立中...";

            fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    console.log("resp:", data);
                    var respTopic = data['respTopic'];
                    msg.innerHTML = "匯入知識集...";
                    mqtt.subscribe(respTopic, function (mqttMsg) {
                        msg.innerHTML = mqttMsg;
                        if (mqttMsg.indexOf("true ") == 0) {
                            msg.innerHTML =
                                '<a href="../chat.html#guest?actor=' + aiName + '">開啟小書僮</a>';
                        }
                    });
                })
                .catch(error => {
                    console.error('發生錯誤:', error);
                });
        }
        var mqtt = new MQTTApp("" + Math.random());
        mqtt.connect();
    </script>

</body>

</html>