<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        #header {
            background-color: lightgray;
            padding: 10px;
        }

        #content {
            display: flex;
            flex: 1;
        }

        #left {
            width: 33%;
            padding: 10px;
        }

        #middle {
            width: 33%;
            padding: 10px;
        }

        #right {
            width: 33%;
            padding: 10px;
        }
    </style>

</head>

<body>
    <div id="container">
        <div id="header">
            <button onclick="processCode()">Go</button>
            <button onclick="removeLines()">Remove</button>
        </div>
        <div id="content">
            <textarea id="left" style="height: 100%; width: 100%;"></textarea>
            <textarea id="middle" style="height: 100%; width: 100%;"></textarea>
            <textarea id="right" style="height: 100%; width: 100%;"></textarea>
        </div>
    </div>


    <script>
        var idx = 0;
        document.addEventListener('keydown', function (event) {
            if (event.key === '1') {
                processCode();
                if (document.getElementById('middle').value == '' &&
                    document.getElementById('right').value == '') {
                    alert('error');
                } else {
                    removeLines();
                }
            }
        });

        function removeLines() {
            var code = document.getElementById('left').value;
            var lines = code.split('\n');
            lines.splice(0, idx + 1);
            document.getElementById('left').value = lines.join('\n');
        }

        var codeType = -1;          //0:python,1:flow
        var strCodeType = '';
        var inCodeBlock = false;
        var codeFirstLine = true;

        var pythonCode = '';
        var graphvizCode = '';
        var resp = '';

        document.getElementById('middle').value = '';
        document.getElementById('right').value = '';


        async function processCode() {
            var code = document.getElementById('left').value;
            var lines = code.split('\n');

            for (var i = 0; i < lines.length - 1; i++) {
                if (!appendToCodeBlock(lines[i], i == lines.length)) {
                    resp = resp + (lines[i] + '\n');
                }
            }
            document.getElementById('middle').value = pythonCode;
            document.getElementById('right').value = graphvizCode ;
            console.log(resp);
            resp = '';
        }

        function appendToCodeBlock(data, isEnd) {
            var line = data.trim();
            // not start codeBlock
            if (!inCodeBlock && !line.startsWith('```')) {
                return false;
            }
            // end codeBlock
            if (inCodeBlock && line.startsWith("```")) {
                codeType = -1;
                strCodeType = '';
                inCodeBlock = false;
                codeFirstLine = true;
                return true;
            }
            // start codeBlock
            if (!inCodeBlock && line.startsWith("```")) {
                inCodeBlock = true;
                strCodeType = line.substring(3).trim();
                return true;
            }
            if (strCodeType == 'python') {
                codeType = 0;
            }
            else if (strCodeType == 'dot' ||
                strCodeType == 'flow' ||
                strCodeType == 'mermaid' ||
                strCodeType == 'graphviz' ||
                strCodeType.startsWith('digraph')) {
                codeType = 1;
            }
            if (codeType == -1 && codeFirstLine) {
                if (line.startsWith("#") ||
                    line.startsWith("import") ||
                    line.startsWith("for") ||
                    line.startsWith("print")) {
                    codeType = 0;
                    codeFirstLine = false;
                } else if (line.startsWith("digraph")) {
                    codeType = 1;
                    codeFirstLine = false;
                }
            }
            if (codeType == 1 && codeFirstLine) {
                // fix: ```digraph{
                if (line.indexOf("{" == -1)) {
                    line = "{\n" + line;
                }
            }
            switch (codeType) {
                case 0:
                    pythonCode = pythonCode + (data + "\n");
                    break;
                case 1:
                    // fix: }```
                    if (data.indexOf('```') >= 0) {
                        codeType = -1;
                        inCodeBlock = false;
                        codeFirstLine = true;
                        strCodeType = '';
                        data = data.replace('```', '');
                        break;
                    }
                    graphvizCode = graphvizCode + (data + "\n");
                    break;
            }
            return true;
        }


        ((async function () {
            await fetch('./p.txt')
                .then(function (response) {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Error: ' + response.status);
                    }
                })
                .then(function (text) {
                    document.getElementById('left').value = text;
                })
                .catch(function (error) {
                    console.log(error);
                });
        })());
    </script>
</body>

</html>