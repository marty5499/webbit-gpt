<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        #header {
            background-color: lightgray;
            padding: 10px;
        }

        #content {
            display: flex;
            flex: 1;
        }

        #left {
            width: 33%;
            padding: 10px;
        }

        #middle {
            width: 33%;
            padding: 10px;
        }

        #right {
            width: 33%;
            padding: 10px;
        }
    </style>

</head>

<body>
    <div id="container">
        <div id="header">
            <button onclick="processCode()">Go</button>
            <button onclick="removeLines()">Remove</button>
        </div>
        <div id="content">
            <textarea id="left" style="height: 100%; width: 100%;"></textarea>
            <textarea id="middle" style="height: 100%; width: 100%;"></textarea>
            <textarea id="right" style="height: 100%; width: 100%;"></textarea>
        </div>
    </div>


    <script>
        var idx = 0;
        document.addEventListener('keydown', function (event) {
            if (event.key === '1') {
                processCode();
                if (document.getElementById('middle').value == '' &&
                    document.getElementById('right').value == '') {
                    alert('error');
                } else {
                    removeLines();
                }
            }
        });

        function removeLines() {
            var code = document.getElementById('left').value;
            var lines = code.split('\n');
            lines.splice(0, idx + 1);
            document.getElementById('left').value = lines.join('\n');
        }

        class CodeBlock {
            constructor() {
                this.reset();
                this.pyCB = function (code) { console.log("pyCode:\n", code) };
                this.gpCB = function (code) { console.log("gpCode:\n", code) };
            }

            reset() {
                this.codeType = -1;          //0:python,1:flow
                this.strCodeType = '';
                this.inCodeBlock = false;
                this.codeFirstLine = true;
                this.pythonCode = '';
                this.graphvizCode = '';
                this.fixSign = false;
            }

            addCallback(pyCB, gpCB) {
                this.pyCB = pyCB;
                this.gpCB = gpCB;
            }

            parseLine(data, isEnd) {
                var line = data.trim();
                // not start codeBlock
                if (!this.inCodeBlock && !line.startsWith('```')) {
                    return 0;
                }
                // end codeBlock
                if (this.inCodeBlock && line.startsWith("```")) {
                    if (this.fixSign) {
                        this.graphvizCode = this.graphvizCode + "}";
                    }
                    this.pyCB(this.pythonCode);
                    this.gpCB(this.graphvizCode);
                    this.reset();
                    return 2; // parse done.
                }
                // start codeBlock
                if (!this.inCodeBlock && line.startsWith("```")) {
                    this.inCodeBlock = true;
                    this.strCodeType = line.substring(3).trim();
                    return 1; //parsing...
                }
                if (this.strCodeType == 'python') {
                    this.codeType = 0;
                }
                else if (this.strCodeType == 'dot' ||
                    this.strCodeType == 'flow' ||
                    this.strCodeType == 'mermaid' ||
                    this.strCodeType == 'graphviz' ||
                    this.strCodeType.startsWith('digraph')) {
                    this.codeType = 1;
                }
                if (this.codeType == -1 && this.codeFirstLine) {
                    if (line.startsWith("#") ||
                        line.startsWith("import") ||
                        line.startsWith("for") ||
                        line.startsWith("print")) {
                        this.codeType = 0;
                        this.codeFirstLine = false;
                    } else if (line.startsWith("digraph")) {
                        this.codeType = 1;
                        this.codeFirstLine = false;
                    }
                }
                if (this.codeType == 1 && this.codeFirstLine) {
                    this.codeFirstLine = false;
                    // fix: ```digraph{
                    if (line.indexOf("{" == -1)) {
                        data = "{\n" + data;
                        this.fixSign = true;
                    }
                }
                switch (this.codeType) {
                    case 0:
                        this.pythonCode = this.pythonCode + (data + "\n");
                        this.pyCB(this.pythonCode);
                        break;
                    case 1:
                        // fix: }```
                        if (data.indexOf('```') >= 0) {
                            this.reset();
                            data = data.replace('```', '');
                            break;
                        }
                        this.graphvizCode = this.graphvizCode + (data + "\n");
                        this.gpCB(this.graphvizCode);
                        break;
                }
                return 1;
            }
        }

        var codeBlock = new CodeBlock();
        document.getElementById('middle').value = '';
        document.getElementById('right').value = '';
        codeBlock.addCallback(function (pyCode) {
            document.getElementById('right').value = pyCode;
        }, function (gpCode) {
            document.getElementById('middle').value = gpCode;
        })

        async function processCode() {
            var code = document.getElementById('left').value;
            var lines = code.split('\n');
            for (var i = 0; i < lines.length - 1; i++) {
                console.log(">>>>>>", i);
                var last = i == lines.length;
                switch (codeBlock.parseLine(lines[i], last)) {
                    case 0:
                        console.log(lines[i]);
                        break;
                    case 1:
                        break;
                    case 2:
                        await new Promise(r => setTimeout(r, 700));
                        break;
                }
            }
        }

        ((async function () {
            await fetch('./p.txt')
                .then(function (response) {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Error: ' + response.status);
                    }
                })
                .then(function (text) {
                    document.getElementById('left').value = text;
                })
                .catch(function (error) {
                    console.log(error);
                });
        })());
    </script>
</body>

</html>