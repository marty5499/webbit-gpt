<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <!-- MQTT -->
    <script src="../js/mqttapp.js"></script>
    <!-- REPL -->
    <script src="../js/repl.js" type="text/javascript"></script>

    <script type="module" src="../coms/wa-select-prompt.js"></script>
    <script type="module" src="../coms/wa-voice.js"></script>
    <script type="module" src="../coms/wa-deploy-bitv2.js"></script>
    <script type="module" src="../coms/wa-gpt-bot.js"></script>
    <script type="module" src="../coms/wa-carousel.js"></script>

    <style>
        body {
            margin: 0px;
        }

        .quiz-panel {
            margin: 15px;
            height: calc(30vh);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;

        }

        .chat-panel {
            margin: 5px;
            height: calc(70vh - 130px);
            background-color: #eee;
        }

        .menuBar {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 46px;
        }

        .menuBtn {
            float: left;
            margin: 5px;
        }
    </style>
</head>

<body>
    <div id="gptbot-content">
        <div class="quiz-panel">
            <wa-carousel id="carousel"></wa-carousel>
        </div>
        <div class="chat-panel">
            <wa-select-prompt style="width:100%"></wa-select-prompt><br>
            <wa-gpt-bot id="gpt"></wa-gpt-bot>
            <div class="menuBar">
                <wa-voice id='voice' class='menuBtn' callback="voiceToTextarea"></wa-voice>
                <wa-gpt-btn id="sendBtn" class='menuBtn' callback="send"></wa-gpt-btn>
                <wa-deploy-bitv2 id="deploy" class='menuBtn'></wa-deploy-bitv2>
            </div>
        </div>
    </div>

    <script>
        var isCode = false;
        var codeType = ['python', 'flow'];
        var _codeType = -1;
        var genCode = '';
        var wholeMsg = '';
        const textarea = document.getElementById('show');
        const voice = document.getElementById('voice');
        const carousel = document.getElementById('carousel');
        function voiceToTextarea(str) {
            gpt.prompt(str);
        }

        function appendToShow(msg, isEnd) {
            wholeMsg += msg;
            if (msg == '') return;
            try {
                setCode(msg);
            } catch (e) { }
            if (!isCode) {
                var cnt = gpt.read();
                cnt = cnt + msg + "<br>";
                gpt.write(cnt);
            }
            //* enhance code function
            if (isEnd) {
                gpt.done();
                parent.flow.done();
                deploy.setEnable(true);
                //var code = parent.editor.getCode();
                //parent.editor.setCode(code);
            }
            //*/
        }

        function setGenCode(code) {
            switch (_codeType) {
                case 0: // python
                    parent.editor.setCode(code);
                    break;
                case 1:
                    parent.flow.setCode(code);
                    break;
            }
        }

        function setCode(code) {
            if (code.indexOf('```') == 0 && isCode) {
                isCode = false;
                genCode = '';
                return;
            }
            if (code.indexOf('```') == 0) {
                _codeType = ++_codeType;
                isCode = true;
                return;
            }
            if (!isCode) return;
            genCode = genCode + code + '\n';
            setGenCode(genCode);
        }
        var userId = "v2";
        if (parent.location.hash.length > 1) {
            userId = parent.location.hash.substring(1);
        }
        const app = new MQTTApp(userId + "_" + Math.random());
        async function init() {
            await app.init(appendToShow);
            gpt.promptCallback(function (prompt) {
                wholeMsg = '';
                _codeType = -1; // -1:none , 0:python , 1:flow
                console.log("prompt callback:", prompt);
                app.publish(carousel.actor + ":" + prompt);
                gpt.start(carousel.actor);

                deploy.setEnable(false);
                parent.flow.processing();
                parent.editor.setCode("");
            });
        }
    </script>
</body>

</html>