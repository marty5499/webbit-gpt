<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <!-- MQTT -->
    <script src="../js/mqttapp.js"></script>
    <!-- Flow Enhance -->
    <script src="../js/fixFlow.js"></script>
    <!-- Google Font Material Symbol -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Icons&display=swap">

    <script type="module" src="../coms/wa-select-prompt.js"></script>
    <script type="module" src="../coms/wa-voice.js"></script>
    <!--
    <script type="module" src="../coms/wa-deploy-bitv2.js"></script>
    -->
    <script type="module" src="../coms/wa-gpt-bot.js"></script>
    <script type="module" src="../coms/wa-carousel.js"></script>

    <style>
        :root {
            height: 100%;
        }

        body {
            margin: 0px;
            height: 100%;
        }

        .quiz-panel {
            height: calc(240px);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-panel {
            margin: 5px;
            height: calc(70vh - 130px);
            background-color: #eee;
        }

        .menuBar {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 46px;
        }

        .menuBtn {
            float: left;
            margin: 5px;
        }

        #gptbot-content {
            height: 100%;
        }
    </style>
</head>

<body>

    <div id="gptbot-content">
        <div class="quiz-panel">
            <wa-carousel id="carousel"></wa-carousel>
        </div>
        <div class="chat-panel">
            <wa-select-prompt style="width:100%"></wa-select-prompt><br>
            <wa-gpt-bot id="gpt"></wa-gpt-bot>
            <br>
            <div class="menuBar">
                <wa-voice id='voice' class='menuBtn' callback="voiceToTextarea"></wa-voice>
                <wa-gpt-btn id="sendBtn" class='menuBtn' callback="send"></wa-gpt-btn>
                <!--
                <wa-deploy-bitv2 id="deploy" class='menuBtn'></wa-deploy-bitv2>
                -->
            </div>
        </div>
    </div>

    <script>
        class Cookie {
            constructor(months) {
                this.expires = new Date();
                this.expires.setMonth(this.expires.getMonth() + months);
            }

            set(key, value) {
                document.cookie = `${key}=${value};expires=${this.expires.toUTCString()}`;
            }

            get(key) {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(key + '=')) {
                        return cookie.substring(key.length + 1);
                    }
                }
                return '';
            }
        }

        var isCode = false;
        var codeType = ['python', 'flow'];
        var _codeType = -1;
        var genCode = '';
        var wholeMsg = '';
        const textarea = document.getElementById('show');
        const voice = document.getElementById('voice');
        const carousel = document.getElementById('carousel');
        const cookie = new Cookie(2);



        function voiceToTextarea(str) {
            if (str.trim() == '') return;
            gpt.prompt(str);
        }

        function appendToShow(msg, isEnd) {
            if (isEnd) {
                var uuid = msg.split('\n\n$UUID$')[1];
                if (typeof (uuid) != "undefined") {
                    msg = msg.split('\n\n$UUID$')[0];
                    gpt.setUUID(uuid);
                }
                gpt.setEnable(true);
            }
            //console.log(isEnd, msg);
            wholeMsg = wholeMsg + "\n" + msg;
            if (msg == '') return;
            try {
                var isCode = setCode(msg);
                //console.log(isCode, msg);
                // filter ``` , ```\n , }``` , }```\n
                if (!isCode &&
                    ((msg.indexOf('```') == 0) ||
                        (msg.indexOf('}```') == 0)))
                    msg = '&nbsp;&nbsp;&nbsp;完成\n';
            } catch (e) { }
            if (!isCode) {
                var cnt = gpt.read();
                cnt = cnt + msg + "<br>";
                gpt.write(cnt);
            }
            //* enhance code function
            if (isEnd) {
                gpt.done();
                gpt.wholeMsg = wholeMsg;
                parent.flow.done();
                // fix dirty codegen
                var code = parent.editor.getCode();
                code = code.replace('from webduino import WebBit', 'from webduino.webbit import WebBit');
                code = code.replace('from Webbit import Webbit', 'from webduino.webbit import WebBit');
                code = code.replace('webbit = Webbit()', 'webbit = WebBit()');
                code = code.replace('wbit.no_tone(0)', '');
                code = code.replace('wbit.tone(0,', 'wbit.tone(');
                parent.editor.setCode(code);
            }
            //*/
        }

        function setGenCode(code) {
            switch (_codeType) {
                case 0: // python
                    parent.editor.setCode(code);
                    break;
                case 1:
                    parent.flow.setCode(tunningFlow(code));
                    //parent.flow.setCode(code);
                    break;
            }
        }

        function tunningFlow(code) {
            let fixCode = code;
            var pos = fixCode.indexOf('{');
            if (pos >= 0) {
                fixCode = fixCode.substring(0, pos + 1) +
                    '\nrankdir=TB\n' +
                    'node[shape=box, style=filled, fillcolor=lightyellow]\n' +
                    fixCode.substring(pos + 1);
            }
            let left = code.split('{').length - 1;
            let right = code.split('}').length - 1;
            let add = left - right;
            for (i = 0; i < add; i++) {
                fixCode += "}"
            }
            // enhance
            fixCode = ff.convert(fixCode);
            //console.log(fixCode);
            return fixCode;
        }

        function isUrlEncoded(str) {
            try {
                decodeURIComponent(str);
                return true;
            } catch (e) {
                return false;
            }
        }

        function setCode(code) {
            if (code.indexOf('```') >= 0 && isCode) {
                var pos = code.indexOf('```');
                if (pos > 0) {
                    genCode = genCode + code.substring(0, pos) + '\n';
                    setGenCode(genCode);
                }
                genCode = '';
                isCode = false;
                return isCode;
            }
            if (code.indexOf('```') == 0) {
                if (code.length > 3) {
                    genCode = genCode +
                        code.replace('```dot', '')
                            .replace('```python', '')
                            .replace('```graphviz', '')
                            .replace('```', '');
                }
                _codeType = ++_codeType;
                // when codeGen completed , check deploy btn if necessary
                if (_codeType == 1) {
                    var info = parseURL(parent.location.href);
                    if (info['actor'] == 'wbit') {
                        parent.Main.coms['deploy'].setEnable(true);
                    }
                }
                isCode = true;
                return isCode;
            }
            if (!isCode) return isCode;
            genCode = genCode + code + '\n';
            setGenCode(genCode);
            return isCode
        }

        function parseURL(str) {
            if (str.indexOf('#') < 0 || str.indexOf('#?') > 0) {
                str = cookie.get('userId');
                //str = str == '' ? '' : str;
                if (str == '') {
                    parent.Main.popup(
                        "還差一步!",
                        "填寫表單就能申請體驗囉! <a href='https://webduino.pse.is/gpt_er'>我要申請</a>",
                        "info", "知道了")
                    return;
                }
                if (parent.location.href.indexOf('?') > 0) {
                    var data = parent.location.href.split('?');
                    parent.location.href = data[0] + '#' + str + '?' + data[1];
                }
            }
            var result = { 'prompt': '', 'actor': 'python' };
            var userId = '';
            var hashIndex = str.indexOf('#');
            var questionIndex = str.indexOf('?');

            if (hashIndex !== -1) {
                if (questionIndex !== -1) {
                    userId = str.slice(hashIndex + 1, questionIndex);
                } else {
                    userId = str.slice(hashIndex + 1);
                }
                cookie.set('userId', userId);
            } else {
                if (questionIndex !== -1) {
                    userId = '';
                } else {
                    userId = str;
                }
            }

            result.userId = userId == '' ? '' : userId;
            if (questionIndex !== -1) {
                var params = str.slice(questionIndex + 1).split('&');
                for (var i = 0; i < params.length; i++) {
                    var parts = params[i].split('=');
                    result[parts[0]] = decodeURIComponent(parts[1].replace(/\+/g, ' '));
                }
            }
            return result;
        }

        var info = parseURL(parent.location.href);
        const app = new MQTTApp(info['userId'] + "_" + Math.random());

        async function init() {
            parent.Main.registry("gpt", gpt);
            parent.Main.registry("voice", voice);
            //parent.Main.registry("deploy", deploy);
            parent.Main.registry("flow", parent.flow);
            parent.Main.registry("carousel", carousel);
            parent.Main.registry("editor", parent.editor);
            gpt.setMQTT(app);
            gpt.prompt(info['prompt']);
            await app.init(appendToShow);

            //將事件轉發到 Main
            carousel.select(function (idx, name) {
                parent.Main.eventTrigger("carousel", "setActor", [idx, name]);
            });
            carousel.setActor(info['actor'], true);

            gpt.promptCallback(function (prompt) {
                parent.Main.coms['output'].cls();
                if (parent.Main.coms['mqtt'].failure) {
                    alert('連線中斷，請重新整理網頁');
                }
                gpt.setEnable(false);
                parent.location.hash =
                    '#' + info['userId'] +
                    '?prompt=' + encodeURIComponent(prompt) +
                    '&actor=' + carousel.actor;
                wholeMsg = '';
                genCode = '';
                isCode = false;
                _codeType = -1; // -1:none , 0:python , 1:flow
                //console.log("prompt callback:", prompt);
                app.publish(carousel.actor + ":" + prompt);
                gpt.start(carousel.actor);
                parent.Main.coms['deploy'].setEnable(false);
                parent.flow.processing();
                parent.editor.setCode("");
            });
        }
    </script>
</body>

</html>