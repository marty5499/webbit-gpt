<!DOCTYPE html>
<html>

<head>
    <title>PDF Viewer</title>
    <!-- 引入 pdf.js 相關的 CSS 檔案 -->
    <link rel="stylesheet" type="text/css" href="https://mozilla.github.io/pdf.js/web/viewer.css">
    <style>
        #pdfContainer {
            height: 100vh;
            overflow-y: scroll;
        }

        .highlight {
            background-color: yellow;
        }
    </style>
</head>

<body>
    <div id="pdfContainer">
    </div>
    <!-- 引入 pdf.js 相關的 JavaScript 檔案 -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script>
        var selectedText = ""; // 用於存儲選取的文字
        var highlightTimeout;

        function loadPDF() {
            var pdfUrl = './book.pdf';
            var pdfContainer = document.getElementById("pdfContainer");

            // Initialize PDF.js settings
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.js';

            // Start loading the PDF
            pdfjsLib.getDocument(pdfUrl).promise.then(async function (pdfDoc) {
                for (var pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                    await renderPage(pdfDoc, pageNum, pdfContainer);
                }
            });
        }

        async function renderPage(pdfDoc, pageNum, pdfContainer) {
            const page = await pdfDoc.getPage(pageNum);
            var scale = 1;
            var viewport = page.getViewport({ scale: scale });
            var canvas = document.createElement("canvas");
            var context = canvas.getContext('2d');
            var textLayerDiv = document.createElement("div");
            var pageDiv = document.createElement("div");

            // Set up pageDiv
            pageDiv.style.position = 'relative';
            pageDiv.style.width = viewport.width + "px";
            pageDiv.style.height = viewport.height + "px";
            pageDiv.style.marginBottom = '20px';

            // Set up text layer
            textLayerDiv.className = "textLayer";
            textLayerDiv.style.width = "100%";
            textLayerDiv.style.height = "100%";
            textLayerDiv.style.position = 'absolute';
            textLayerDiv.style.top = "0";
            textLayerDiv.style.left = "0";
            textLayerDiv.style.setProperty("--scale-factor", scale);

            // Set up the canvas
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.width = "100%";
            canvas.style.height = "100%";
            canvas.style.position = 'absolute';
            canvas.style.top = "0";
            canvas.style.left = "0";

            // Append elements to the pageDiv
            pageDiv.appendChild(canvas);
            pageDiv.appendChild(textLayerDiv);

            // Render the page onto the canvas
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;

            // Retrieve the text content and render it onto the textLayer
            const textContent = await page.getTextContent();

            // Use textContentSource instead of textContent
            pdfjsLib.renderTextLayer({
                textContentSource: textContent,
                container: textLayerDiv,
                viewport: viewport,
                textDivs: []
            });

            // Append the rendered page to the container
            pdfContainer.appendChild(pageDiv);

            // Add event listener for text selection
            textLayerDiv.addEventListener("mouseup", function (event) {
                var selectedRange = window.getSelection().getRangeAt(0);
                selectedText = selectedRange.toString().trim();
                setTimeout(function () {
                    console.log(selectedText);
                }, 1000);
            });

            textLayerDiv.addEventListener("mouseover", function (event) {
                if (highlightTimeout) clearTimeout(highlightTimeout);

                highlightTimeout = setTimeout(function () {
                    var target = event.target;

                    // Skip if the target is not a span (i.e., not a text element)
                    if (target.tagName.toLowerCase() !== 'span') return;

                    // Remove all existing highlights
                    var highlightedElements = document.querySelectorAll('.highlight');
                    highlightedElements.forEach(function (element) {
                        element.classList.remove('highlight');
                    });

                    // Get the position of the target element
                    var targetRect = target.getBoundingClientRect();

                    // Get all text elements
                    var textElements = Array.from(textLayerDiv.getElementsByTagName('span'));

                    // Function to check if an element is in the same block as the target
                    var isInSameBlock = function (element) {
                        var rect = element.getBoundingClientRect();

                        // Check if the element is in the same line as the target
                        // This is a simple check and might not work correctly for all PDFs
                        return Math.abs(rect.top - targetRect.top) < rect.height * 3;
                    };

                    // Get all elements in the same block
                    var sameBlockElements = textElements.filter(isInSameBlock);

                    if (sameBlockElements.length) {
                        console.log('Text block:', sameBlockElements.map(function (element) {
                            return element.textContent;
                        }).join(' '));

                        // Highlight all elements in the same block
                        sameBlockElements.forEach(function (element) {
                            element.classList.add('highlight');
                        });
                    }
                }, 1000);
            });
        }

        loadPDF();
    </script>
</body>

</html>